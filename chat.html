<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kstacking Chat üí¨ Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --text: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 40%);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;

      /* üî• ADD THIS ‚Äî center logo LIGHT watermark */
    position: relative;
    }

    /* üî• Ghost logo watermark background */
  body::before {
    content: "";
    position: absolute;
    inset: 0;
    background: url("images/Brand.png") no-repeat center 120px;
    background-size: 420px auto;
    opacity: 0.25;              /* üî• beautiful watermark fade */
    pointer-events: none;
    z-index: 0;
}


    .chat-page-header {
      margin-top: 24px;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      text-align: center;
    }

    .chat-page-subtitle {
      margin-top: 8px;
      margin-bottom: 24px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      max-width: 480px;
    }

    /* üí¨ Kstacking Chat basic styles */
    .kchat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    .kchat-toggle {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #39ff14;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 0 16px rgba(57, 255, 20, 0.55);
    }

    .kchat-toggle:hover {
      background: #022c22;
    }

    .kchat-window {
      position: absolute;
      bottom: 55px;
      right: 0;
      width: 320px;
      max-height: 460px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      display: none;           /* hidden by default */
      flex-direction: column;
      overflow: hidden;
    }

    .kchat-header {
      padding: 10px 12px;
      background: radial-gradient(circle at top left, #39ff14 0, #0f172a 45%, #020617 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer; /* so people know they can tap to expand */
    }

    .kchat-title {
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
      display: block;
    }

    .kchat-subtitle {
      font-size: 11px;
      color: #cbd5f5;
      display: block;
    }

    .kchat-close {
      border: none;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
    }

    .kchat-max-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      padding: 0 6px;
      font-weight: 600;     /* bold like the X */
    }

    .kchat-messages {
      padding: 10px;
      background: #020617;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kchat-message {
      max-width: 90%;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kchat-message-system .kchat-bubble {
      background: #111827;
      color: #e5e7eb;
      border-radius: 12px;
      border-bottom-left-radius: 2px;
      padding: 8px 10px;
      font-size: 12px;
    }

    .kchat-meta {
      font-size: 10px;
      color: #39ff14; /* neon username + time */
    }

    .kchat-bubble {
      background: #020617;
      color: #e5e7eb;
      border-radius: 12px;
      border-bottom-left-radius: 2px;
      padding: 8px 10px;
      font-size: 12px;
      border: 1px solid #1f2937;
    }

    .kchat-input-row {
      border-top: 1px solid #1f2937;
      padding: 8px;
      display: flex;
      gap: 6px;
      background: #020617;
    }

    .kchat-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .kchat-input::placeholder {
      color: #64748b;
    }

    .kchat-send-btn {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background: #39ff14;
      color: #022c22;
    }

    .kchat-message-user {
      align-self: flex-end;
    }

    .kchat-message-user .kchat-bubble {
      background: #ffffff;
      color: #000000;
      border-radius: 12px;
      border-bottom-right-radius: 2px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 700;
    }

    /* FULLSCREEN MODE */
    .kchat-expanded {
      width: 95vw !important;
      height: 90vh !important;

      max-height: none !important;
      bottom: 2vh !important;
      right: 2vw !important;

      border-radius: 12px !important;
      transition: all 0.25s ease-in-out;
    }

    @media (max-width: 768px) {
      .kchat-window {
        height: 35vh;
        bottom: 20px;
        max-width: 100vw;
        overflow-y: auto;
        border-radius: 18px 18px 0 0;
        right: 0;
        left: 0;
        margin: 0 auto;
      }

      .kchat-header {
        border-radius: 18px 18px 0 0;
      }

      body {
        padding: 12px;
      }
    }

    @media (max-width: 768px) {

    /* Center the floating chat launcher bubble */
    .kchat-toggle {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
    }

    /* Center the chat window on mobile */
    .kchat-window {
        right: 50% !important;
        left: auto !important;
        transform: translateX(50%) !important;
        max-width: 95vw;  /* prevents edge clipping */
    }
}

    @media (max-width: 768px) {

    .kchat-window {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important; /* PERFECT CENTER */
        max-width: 92vw; /* small breathing room on edges */
    }
}


  .kchat-back-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 9999;

  background: #39ff14;
  color: #020617;
  
  padding: 10px 18px;
  border-radius: 999px;
  font-size: 14px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;

  /* White accent border */
  border: 2px solid rgba(255,255,255,0.9);

  /* Dual halo glow */
  box-shadow:
      0 0 10px rgba(255,255,255,0.8),  /* white glow */
      0 0 16px rgba(57,255,20,0.55);   /* neon green glow */

  transition: 0.25s ease;
}

.kchat-back-btn:hover {
  background: #65ff4b;
  transform: translateY(-2px);
}


  </style>

  <link rel="icon" type="image/png" href="/images/favicon64.png">
</head>
<body>

  <h1 class="chat-page-header">Kstacking Chat üí¨ Live</h1>
  <p class="chat-page-subtitle">
    Respect the pit ¬∑ No hate ¬∑ Share SPY levels, lottos, stocks positions & thoughts.
  </p>

  <a href="index.html" class="kchat-back-btn">‚Üê Back to ü§ëKstacking</a>


  <!-- üí¨ KSTACKING CHAT WIDGET -->
  <div class="kchat-widget">
    <button class="kchat-toggle" id="kchatToggle">
      Open Kstacking Chat
    </button>

    <div class="kchat-window" id="kchatWindow">
      <div class="kchat-header">
        <div>
          <span class="kchat-title">Kstacking Chat üí¨ Live</span>
          <span class="kchat-subtitle">Drop what you got, lottos, positions & thoughts</span>
        </div>
        <button id="kchatMax" class="kchat-max-btn">‚§¢</button>
        <button class="kchat-close" id="kchatClose">‚úï</button>
      </div>

      <div class="kchat-messages" id="kchatMessages">
        <div class="kchat-message kchat-message-system">
          <div class="kchat-meta">System ¬∑ just now</div>
          <div class="kchat-bubble">
            Welcome to <strong>Kstacking Chat üí¨ Live</strong> ‚Äì respect the pit, no hate.
          </div>
        </div>
      </div>

      <form class="kchat-input-row" id="kchatForm">
        <input
          type="text"
          id="kchatInput"
          class="kchat-input"
          placeholder="Type your message‚Ä¶"
          autocomplete="off"
        />
        <button type="submit" class="kchat-send-btn">Send</button>
      </form>
    </div>
  </div>
  <!-- END KSTACKING CHAT WIDGET -->

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Your Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyDjUOlDr4k2zXydTM4Q4tO-Qa-xz4zEbtw",
      authDomain: "kstacking-chat.firebaseapp.com",
      projectId: "kstacking-chat",
      storageBucket: "kstacking-chat.firebasestorage.app",
      messagingSenderId: "830202672646",
      appId: "1:830202672646:web:93eaf224d169c8558ab587"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Create Firestore database connection
    var db = firebase.firestore();
  </script>

  <script>
    // === USERNAME LOGIC (pick or random) ==========================
    function makeRandomName() {
      const words = [
        "Bull", "Bear", "Coqui", "Falcon", "Wolf",
        "Panther", "Shark", "Trader", "Gamma", "Breakout"
      ];
      const w = words[Math.floor(Math.random() * words.length)];
      const num = Math.floor(Math.random() * 900 + 100); // 100‚Äì999
      return `${w}-${num}`;
    }

    // v2 key so everyone gets prompted at least once
    let ksUsername = localStorage.getItem("kschat_username_v2");

    if (!ksUsername) {
      let chosen = prompt(
        "Pick a chat nickname (or leave blank for a random one):",
        ""
      );

      if (!chosen || !chosen.trim()) {
        ksUsername = makeRandomName();
      } else {
        ksUsername = chosen.trim().slice(0, 18); // keep it short
      }

      localStorage.setItem("kschat_username_v2", ksUsername);
    }

    // === Grab chat elements =======================================
    const kToggle   = document.getElementById("kchatToggle");
    const kWindow   = document.getElementById("kchatWindow");
    const kClose    = document.getElementById("kchatClose");
    const kForm     = document.getElementById("kchatForm");
    const kInput    = document.getElementById("kchatInput");
    const kMessages = document.getElementById("kchatMessages");
    const kHeader   = document.querySelector(".kchat-header");
    const kMaxBtn   = document.getElementById("kchatMax");

    // üëâ OPEN BY DEFAULT WHEN PAGE LOADS
window.addEventListener("load", () => {
  kWindow.style.display = "flex";
});

  // --- Open / close widget ---
    kToggle.addEventListener("click", () => {
      kWindow.style.display = "flex";
    });

    kClose.addEventListener("click", () => {
      kWindow.style.display = "none";
    });

    // --- Toggle fullscreen chat mode (click header or max btn) ---
    function toggleExpand() {
      kWindow.classList.toggle("kchat-expanded");
    }

    kHeader.addEventListener("click", (e) => {
      // avoid closing when clicking the X
      if (e.target === kClose) return;
      toggleExpand();
    });

    kMaxBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleExpand();
    });

    // --- Helper to create a chat bubble ---
    function appendMessageBubble(text, metaLabel, isUser) {
      const wrapper = document.createElement("div");
      wrapper.className = "kchat-message" + (isUser ? " kchat-message-user" : "");

      const meta = document.createElement("div");
      meta.className = "kchat-meta";
      meta.textContent = metaLabel;

      const bubble = document.createElement("div");
      bubble.className = "kchat-bubble";
      bubble.textContent = text;

      wrapper.appendChild(meta);
      wrapper.appendChild(bubble);

      kMessages.appendChild(wrapper);
      kMessages.scrollTop = kMessages.scrollHeight;
    }

    // --- Sanitizer ---
    function cleanText(input) {
      return input.replace(/[<>]/g, "");
    }

    // --- Send message (save to Firestore) ---
    let lastMessageTime = 0;

    kForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const text = cleanText(kInput.value.trim());
      if (!text) return;

      // Rate limit: 3 seconds
      let now = Date.now();
      if (now - lastMessageTime < 3000) {
        alert("Slow down champ ‚Äî 3 seconds between messages üíöüòé");
        return;
      }
      lastMessageTime = now;

      db.collection("kstackingMessages").add({
        text: text,
        user: ksUsername,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log("‚úî message saved to Firestore");
        kInput.value = "";
        kInput.focus();
      }).catch(err => {
        console.error("üî• Firestore error:", err);
      });
    });

    // --- Live listener: show all messages to everyone ---
    db.collection("kstackingMessages")
      .orderBy("createdAt", "asc")
      .limit(100)
      .onSnapshot(snapshot => {
        // keep the system welcome message, clear the rest
        const systemMessage = kMessages.querySelector(".kchat-message-system");
        kMessages.innerHTML = "";
        if (systemMessage) kMessages.appendChild(systemMessage);

        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.text) return;

          // nickname + time label
          const name = data.user || "Anon";
          let timePart = "";
          if (data.createdAt && data.createdAt.toDate) {
            const d = data.createdAt.toDate();
            const h = d.getHours().toString().padStart(2, "0");
            const m = d.getMinutes().toString().padStart(2, "0");
            timePart = ` ¬∑ ${h}:${m}`;
          }
          const label = `${name}${timePart}`;

          appendMessageBubble(data.text, label, name === ksUsername);
        });

        kMessages.scrollTop = kMessages.scrollHeight;
      });
  </script>

</body>
</html>
